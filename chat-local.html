<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ABZ Agent – Local Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#007BFF; --ink:#0f172a; --muted:#6b7280; --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --success:#16a34a; --danger:#dc2626; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background: var(--bg); color: var(--ink);
      display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px; }
    .shell { width: min(960px, 100%); background: var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.08); overflow:hidden; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff,#f9fbff); }
    .brand { display:flex; gap:10px; align-items:center; }
    .dots { display:flex; gap:6px; }
    .dot { width:10px; height:10px; border-radius:50%; }
    .dot.red{background:#ff5f56;} .dot.yellow{background:#ffbd2e;} .dot.green{background:#27c93f;}
    .api { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .api input { width: 320px; max-width: 60vw; border:1px solid var(--border); border-radius:10px; padding:8px 10px; outline:none; }
    .btn { background: var(--blue); color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .status { font-size:12px; color:var(--muted); } .status.good { color: var(--success); } .status.bad { color: var(--danger); }
    .chat { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; }
    @media (max-width: 860px){ .chat { grid-template-columns: 1fr; } }
    .pane { border:1px solid var(--border); border-radius:12px; background:#fff; overflow:hidden; display:flex; flex-direction:column; min-height: 440px; }
    .pane h3 { margin:0; padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px; color:var(--muted); }
    .msgs { padding:16px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:10px; background: conic-gradient(from 180deg at 60% -10%, #f6fbff, #fff); }
    .bubble { max-width: 82%; padding:10px 12px; font-size:14px; line-height:1.45; border-radius:14px; box-shadow:0 1px 2px rgba(2,6,23,.06); word-wrap: break-word; white-space: pre-wrap; }
    .me { align-self:flex-end; background: var(--blue); color:#fff; border-bottom-right-radius: 4px; }
    .bot{ align-self:flex-start; background: #eef4ff; color:#111827; border-bottom-left-radius: 4px; }
    .err{ align-self:flex-start; background: #fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); background:#fff; }
    .composer input { flex:1; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    .composer button { width:90px; }
    .mini { font-size:12px; color:var(--muted); padding:8px 16px 0; display:flex; gap:10px; align-items:center; }
    .pill { font-size:11px; border:1px solid var(--border); padding:4px 8px; border-radius:999px; background:#fff; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f1f5f9; border:1px solid #e2e8f0; border-bottom-width:2px; padding:2px 6px; border-radius:6px; }
    .dim { color:var(--muted); }
    .loading-dots > span{ display:inline-block; width:6px; height:6px; border-radius:50%; background:#475569; margin-right:6px; animation:bounce 1s infinite; }
    .loading-dots > span:nth-child(2){ animation-delay:.15s;} .loading-dots > span:nth-child(3){ animation-delay:.3s;}
    @keyframes bounce { 0%,80%,100%{ transform:translateY(0)} 40%{ transform:translateY(-5px)}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="dots">
          <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
        </div>
        <strong>ABZ Agent – Local Chat</strong>
      </div>
      <div class="api">
        <input id="api" value="http://127.0.0.1:8000" />
        <button class="btn" id="health">Check Health</button>
        <span id="lat" class="status">latency: —</span>
      </div>
    </div>

    <div class="chat">
      <div class="pane">
        <h3>Conversation</h3>
        <div id="messages" class="msgs"></div>
        <div class="mini">
          <span class="pill">POST <code class="kbd">/v1/chat</code></span>
          <span class="dim">Enter ↵ to send</span>
        </div>
        <form id="form" class="composer">
          <input id="input" autocomplete="off" placeholder="Type a message…" />
          <button id="send" class="btn" type="submit">Send</button>
        </form>
      </div>

      <div class="pane">
        <h3>Payload / Response</h3>
        <div class="msgs" id="jsonlog" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;"></div>
        <div class="mini">
          <span class="pill">CORS</span>
          <span class="dim">Local dev: server allows all origins.</span>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (sel) => document.querySelector(sel);
  const apiInput = $("#api");
  const msgs = $("#messages");
  const jsonlog = $("#jsonlog");
  const form = $("#form");
  const input = $("#input");
  const sendBtn = $("#send");
  const healthBtn = $("#health");
  const latency = $("#lat");

  function addBubble(text, who="bot", cls="bubble") {
    const div = document.createElement("div");
    div.className = `${cls} ${who === "user" ? "me" : who === "error" ? "err" : "bot"}`;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTo({ top: msgs.scrollHeight, behavior: "smooth" });
  }
  function logJson(title, obj) {
    const wrap = document.createElement("div");
    wrap.style.padding = "8px";
    wrap.style.border = "1px solid #e5e7eb";
    wrap.style.borderRadius = "10px";
    wrap.style.background = "#fff";
    wrap.style.marginBottom = "8px";
    wrap.innerHTML = `<div style="color:#64748b;margin-bottom:6px">${title}</div><pre style="margin:0;white-space:pre-wrap">${JSON.stringify(obj, null, 2)}</pre>`;
    jsonlog.appendChild(wrap);
    jsonlog.scrollTo({ top: jsonlog.scrollHeight, behavior: "smooth" });
  }
  function setLoading(flag) {
    sendBtn.disabled = flag;
    input.disabled = flag;
    if (flag) {
      const loader = document.createElement("div");
      loader.className = "bubble bot";
      loader.id = "loader";
      loader.innerHTML = `<span class="loading-dots"><span></span><span></span><span></span></span> thinking…`;
      msgs.appendChild(loader);
      msgs.scrollTo({ top: msgs.scrollHeight, behavior: "smooth" });
    } else {
      const loader = document.querySelector("#loader");
      if (loader) loader.remove();
    }
  }

  healthBtn.addEventListener("click", async () => {
    const base = apiInput.value.replace(/\/$/, "");
    const url = `${base}/health`;
    const t0 = performance.now();
    try {
      const r = await fetch(url, { cache: "no-store" });
      const t1 = performance.now();
      latency.textContent = `latency: ${Math.round(t1 - t0)} ms`;
      if (!r.ok) { addBubble(`Health ${r.status}`, "error"); return; }
      const data = await r.json();
      logJson("Health", data);
    } catch (e) {
      addBubble(`Health error: ${e.message || e}`, "error");
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    addBubble(text, "user");
    input.value = "";

    const base = apiInput.value.replace(/\/$/, "");
    const url = `${base}/v1/chat`;
    const payload = { messages: [{ role: "user", content: text }] };
    logJson("Request → /v1/chat", payload);

    setLoading(true);
    try {
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const raw = await r.text();
      let data;
      try { data = JSON.parse(raw); } catch { data = { raw }; }

      if (!r.ok) {
        addBubble(`Upstream ${r.status}: ${data.detail || data.error || data.raw || raw}`, "error");
        logJson(`Error ${r.status}`, data);
      } else {
        const msg = data?.message?.content ?? JSON.stringify(data);
        addBubble(msg, "bot");
        logJson("Response ✓", data);
      }
    } catch (e) {
      addBubble(`Network error: ${e.message || e}`, "error");
      logJson("Network error", { error: String(e) });
    } finally {
      setLoading(false);
    }
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.ctrlKey && !e.shiftKey) {
      e.preventDefault();
      form.requestSubmit();
    }
  });
</script>
</body>
</html>
